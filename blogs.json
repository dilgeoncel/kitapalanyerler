// JSON Dosyası ile Blog Sistemi - Herkes Görebilir
// Bu kodu mevcut localStorage kodunuzun yerine ekleyin

// JSON dosyasından blog'ları yükle
async function loadBlogsFromJSON() {
    try {
        const response = await fetch('blogs.json?v=' + Date.now()); // Cache busting
        if (!response.ok) {
            throw new Error('Blog dosyası bulunamadı');
        }
        
        const data = await response.json();
        const blogs = data.posts || [];
        
        const blogPosts = document.getElementById('blog-posts');
        const adminBlogList = document.getElementById('admin-blog-list');
        
        // Blog sayfasını temizle
        blogPosts.innerHTML = '';
        // Admin listesini temizle  
        if (adminBlogList) {
            adminBlogList.innerHTML = '';
        }
        
        if (blogs.length === 0) {
            showEmptyBlogState();
            if (adminBlogList) showEmptyAdminState();
            return;
        }
        
        // Blog yazılarını göster
        blogs.forEach(blog => {
            addBlogToPage(blog);
            if (adminBlogList) addBlogToAdminPanel(blog);
        });
        
    } catch (error) {
        console.error('Blog yükleme hatası:', error);
        showEmptyBlogState();
        
        // Eğer blogs.json yoksa örnek blog'lar göster
        if (error.message.includes('Blog dosyası bulunamadı')) {
            showSampleBlogs();
        }
    }
}

// Örnek blog yazıları göster (blogs.json yoksa)
function showSampleBlogs() {
    const sampleBlogs = [
        {
            id: 'sample-1',
            title: 'İstanbul\'da En Değerli Kitap Türleri',
            content: 'Antika kitaplar, ilk baskılar ve nadir eserler İstanbul\'da en yüksek fiyatları alıyor. Özellikle Osmanlıca kitaplar, imzalı eserler ve akademik yayınlar için özel değerlendirme yapıyoruz. Üniversite kitapları da güncel baskıları ile iyi fiyatlara alınıyor. Tıp, hukuk, mühendislik kitapları özellikle rağbet görüyor. Koleksiyonunuzda değerli kitaplar olduğunu düşünüyorsanız uzman ekibimizle iletişime geçin.',
            imageUrl: 'https://kultur.istanbul/gorsel/2022/03/kapak.png',
            date: '2025-01-22',
            author: 'Kitap Uzmanı'
        },
        {
            id: 'sample-2', 
            title: 'Evden Kitap Toplama Servisi Nasıl Çalışır?',
            content: 'WhatsApp üzerinden iletişime geçtikten sonra uzman ekibimiz adresinize gelir. Kitaplarınızın değer tespitini yapar ve anında nakit ödeme yapar. Hizmet tamamen ücretsizdir ve İstanbul genelinde geçerlidir. Randevu almak için +90 532 688 66 35 numaralı WhatsApp hattımızı arayabilirsiniz. Aynı gün hizmet imkânı da bulunmaktadır.',
            imageUrl: 'https://kultur.istanbul/gorsel/2022/03/kapak.png',
            date: '2025-01-20', 
            author: 'Kitap Uzmanı'
        }
    ];
    
    sampleBlogs.forEach(blog => {
        addBlogToPage(blog);
    });
}

// Sayfaya blog ekle (güncellenmiş versiyon)
function addBlogToPage(blog) {
    const blogPosts = document.getElementById('blog-posts');
    const newPost = document.createElement('div');
    newPost.className = 'blog-post';
    newPost.setAttribute('data-id', blog.id);
    
    const previewText = blog.content.substring(0, 150) + (blog.content.length > 150 ? '...' : '');
    const showReadMore = blog.content.length > 150;
    const imageHtml = blog.imageUrl ? 
        `<img src="${blog.imageUrl}" alt="${blog.title}" onclick="openImageModal('${blog.imageUrl}', '${blog.title}')" title="Fotoğrafı büyütmek için tıklayın" onerror="this.style.display='none';">` : '';
    
    newPost.innerHTML = `
        <div class="blog-post-content">
            ${imageHtml}
            <h3>${blog.title}</h3>
            <div class="blog-post-meta">${blog.date} - ${blog.author}</div>
            <p class="blog-preview">${previewText}</p>
            <div class="full-content" style="display:none;">${blog.content}</div>
            ${showReadMore ? `<a href="#" class="read-more-link" onclick="showFullPost('${blog.id}'); return false;">Devamını Oku &rarr;</a>` : ''}
        </div>
    `;
    
    blogPosts.appendChild(newPost);
}

// Admin paneline blog ekle (güncellenmiş versiyon)
function addBlogToAdminPanel(blog) {
    const adminList = document.getElementById('admin-blog-list');
    if (!adminList) return;
    
    const adminImageHtml = blog.imageUrl ? 
        `<img src="${blog.imageUrl}" alt="${blog.title}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 5px; float: right; cursor: pointer;" onclick="openImageModal('${blog.imageUrl}', '${blog.title}')" title="Fotoğrafı büyütmek için tıklayın">` : '';
    
    const newAdminPost = document.createElement('div');
    newAdminPost.className = 'post-item';
    newAdminPost.setAttribute('data-blog-id', blog.id);
    
    newAdminPost.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div style="flex: 1;">
                <h4>${blog.title}</h4>
                <p style="color: #7f8c8d; font-size: 0.9rem;">${blog.date} - ${blog.author}</p>
                <div class="post-actions">
                    <button type="button" class="btn" style="margin-right: 0.5rem; background: #17a2b8; color: white;" onclick="copyBlogToLocalStorage('${blog.id}')">📋 localStorage'a Kopyala</button>
                    <button type="button" class="btn" style="background: #28a745; color: white;" onclick="downloadBlogAsJSON('${blog.id}')">💾 JSON İndir</button>
                </div>
            </div>
            ${adminImageHtml}
        </div>
    `;
    
    adminList.appendChild(newAdminPost);
}

// localStorage blog'u JSON formatında kopyala
function copyBlogToLocalStorage(blogId) {
    // Bu fonksiyon manuel JSON güncelleme için blog verisini hazırlar
    fetch('blogs.json?v=' + Date.now())
        .then(response => response.json())
        .then(data => {
            const blog = data.posts.find(b => b.id === blogId);
            if (blog) {
                const jsonText = JSON.stringify(blog, null, 2);
                
                // Panoya kopyala
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(jsonText).then(() => {
                        alert('✅ Blog verisi panoya kopyalandı! blogs.json dosyasına ekleyebilirsiniz.');
                    });
                } else {
                    // Fallback: Modal ile göster
                    showCopyModal(jsonText);
                }
            }
        })
        .catch(error => {
            alert('❌ Blog verisi alınamadı: ' + error.message);
        });
}

// Blog'u JSON dosyası olarak indir
function downloadBlogAsJSON(blogId) {
    fetch('blogs.json?v=' + Date.now())
        .then(response => response.json())
        .then(data => {
            const blog = data.posts.find(b => b.id === blogId);
            if (blog) {
                const dataStr = JSON.stringify({posts: [blog]}, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `blog-${blog.id}.json`;
                link.click();
                
                alert('✅ Blog JSON dosyası indirildi!');
            }
        })
        .catch(error => {
            alert('❌ Blog indirilemedi: ' + error.message);
        });
}

// Kopyalama modal'ı göster
function showCopyModal(text) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    `;
    
    modal.innerHTML = `
        <div style="
            background: white;
            padding: 2rem;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        ">
            <h3 style="margin-bottom: 1rem;">Blog JSON Verisi</h3>
            <p style="margin-bottom: 1rem; color: #666;">Bu veriyi kopyalayıp blogs.json dosyanıza ekleyebilirsiniz:</p>
            <textarea readonly style="
                width: 100%;
                height: 300px;
                padding: 1rem;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-family: monospace;
                font-size: 0.9rem;
            ">${text}</textarea>
            <div style="text-align: right; margin-top: 1rem;">
                <button onclick="this.closest('div').parentElement.parentElement.remove()" style="
                    background: #6c757d;
                    color: white;
                    border: none;
                    padding: 0.5rem 1rem;
                    border-radius: 5px;
                    cursor: pointer;
                ">Kapat</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Ana blog yazısı ekleme fonksiyonu (localStorage + JSON uyarısı)
function handleBlogSubmit() {
    const title = document.getElementById('post-title').value;
    const content = document.getElementById('post-content').value;
    const imageUrl = getCurrentImageSrc();

    if (!title || !content) {
        alert('Lütfen başlık ve içerik alanlarını doldurun!');
        return;
    }

    // Blog objesi oluştur
    const blog = {
        id: 'blog-' + Date.now(),
        title: title,
        content: content,
        imageUrl: imageUrl || '',
        date: new Date().toLocaleDateString('tr-TR'),
        author: 'Admin',
        createdAt: new Date().toISOString()
    };
    
    try {
        // localStorage'a kaydet (geçici)
        const savedBlogs = localStorage.getItem('kitap-blog-posts');
        const blogs = savedBlogs ? JSON.parse(savedBlogs) : [];
        blogs.unshift(blog);
        localStorage.setItem('kitap-blog-posts', JSON.stringify(blogs));
        
        // Sayfaya ekle
        const emptyStates = document.querySelectorAll('.empty-state');
        emptyStates.forEach(state => state.remove());
        
        addBlogToPage(blog);
        addBlogToAdminPanel(blog);
        
        // Formu temizle
        document.getElementById('post-title').value = '';
        document.getElementById('post-content').value = '';
        clearImage();
        
        // JSON formatında göster
        const jsonData = JSON.stringify(blog, null, 2);
        
        alert('✅ Blog yazısı eklendi!\n\n⚠️ NOT: Bu sadece sizin tarayıcınızda görünüyor.\n\nHerkesin görmesi için blogs.json dosyasını güncelleyin.');
        
        // JSON verisini göster
        showCopyModal(jsonData);
        
    } catch (error) {
        alert('❌ Blog yazısı kaydedilirken hata oluştu: ' + error.message);
    }
}

// Boş durumları göster (güncellenmiş)
function showEmptyBlogState() {
    const blogPosts = document.getElementById('blog-posts');
    blogPosts.innerHTML = `
        <div class="empty-state" style="text-align: center; padding: 4rem; color: #7f8c8d;">
            <h2 style="color: #95a5a6; margin-bottom: 1rem;">📚 Blog Yazıları</h2>
            <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">Blog yazıları yükleniyor...</p>
            <p style="margin: 0;">blogs.json dosyası bulunamadıysa örnek yazılar gösterilecek.</p>
        </div>
    `;
}

function showEmptyAdminState() {
    const adminBlogList = document.getElementById('admin-blog-list');
    if (!adminBlogList) return;
    
    adminBlogList.innerHTML = `
        <div class="empty-state" style="text-align: center; padding: 2rem; color: #7f8c8d; background: #f8f9fa; border-radius: 10px; border: 2px dashed #ddd;">
            <h4 style="color: #95a5a6; margin-bottom: 1rem;">📝 Blog Yönetimi</h4>
            <p style="margin-bottom: 0.5rem;">blogs.json dosyasından blog yazıları yüklendi.</p>
            <p style="margin: 0; font-size: 0.9rem;">Yeni blog eklemek için yukarıdaki formu kullanın.</p>
        </div>
    `;
}

// Sayfa yüklendiğinde JSON'dan blog'ları yükle
document.addEventListener('DOMContentLoaded', function() {
    // JSON dosyasından blog'ları yükle
    loadBlogsFromJSON();
    
    // Gizli admin ipucunu 10 saniye sonra gizle
    setTimeout(function() {
        const adminHint = document.querySelector('[title="Admin Erişimi: Shift + Ctrl + Q"]');
        if (adminHint) {
            adminHint.style.display = 'none';
        }
    }, 10000);
});
