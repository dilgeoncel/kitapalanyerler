// JSON DosyasÄ± ile Blog Sistemi - Herkes GÃ¶rebilir
// Bu kodu mevcut localStorage kodunuzun yerine ekleyin

// JSON dosyasÄ±ndan blog'larÄ± yÃ¼kle
async function loadBlogsFromJSON() {
    try {
        const response = await fetch('blogs.json?v=' + Date.now()); // Cache busting
        if (!response.ok) {
            throw new Error('Blog dosyasÄ± bulunamadÄ±');
        }
        
        const data = await response.json();
        const blogs = data.posts || [];
        
        const blogPosts = document.getElementById('blog-posts');
        const adminBlogList = document.getElementById('admin-blog-list');
        
        // Blog sayfasÄ±nÄ± temizle
        blogPosts.innerHTML = '';
        // Admin listesini temizle  
        if (adminBlogList) {
            adminBlogList.innerHTML = '';
        }
        
        if (blogs.length === 0) {
            showEmptyBlogState();
            if (adminBlogList) showEmptyAdminState();
            return;
        }
        
        // Blog yazÄ±larÄ±nÄ± gÃ¶ster
        blogs.forEach(blog => {
            addBlogToPage(blog);
            if (adminBlogList) addBlogToAdminPanel(blog);
        });
        
    } catch (error) {
        console.error('Blog yÃ¼kleme hatasÄ±:', error);
        showEmptyBlogState();
        
        // EÄŸer blogs.json yoksa Ã¶rnek blog'lar gÃ¶ster
        if (error.message.includes('Blog dosyasÄ± bulunamadÄ±')) {
            showSampleBlogs();
        }
    }
}

// Ã–rnek blog yazÄ±larÄ± gÃ¶ster (blogs.json yoksa)
function showSampleBlogs() {
    const sampleBlogs = [
        {
            id: 'sample-1',
            title: 'Ä°stanbul\'da En DeÄŸerli Kitap TÃ¼rleri',
            content: 'Antika kitaplar, ilk baskÄ±lar ve nadir eserler Ä°stanbul\'da en yÃ¼ksek fiyatlarÄ± alÄ±yor. Ã–zellikle OsmanlÄ±ca kitaplar, imzalÄ± eserler ve akademik yayÄ±nlar iÃ§in Ã¶zel deÄŸerlendirme yapÄ±yoruz. Ãœniversite kitaplarÄ± da gÃ¼ncel baskÄ±larÄ± ile iyi fiyatlara alÄ±nÄ±yor. TÄ±p, hukuk, mÃ¼hendislik kitaplarÄ± Ã¶zellikle raÄŸbet gÃ¶rÃ¼yor. Koleksiyonunuzda deÄŸerli kitaplar olduÄŸunu dÃ¼ÅŸÃ¼nÃ¼yorsanÄ±z uzman ekibimizle iletiÅŸime geÃ§in.',
            imageUrl: 'https://kultur.istanbul/gorsel/2022/03/kapak.png',
            date: '2025-01-22',
            author: 'Kitap UzmanÄ±'
        },
        {
            id: 'sample-2', 
            title: 'Evden Kitap Toplama Servisi NasÄ±l Ã‡alÄ±ÅŸÄ±r?',
            content: 'WhatsApp Ã¼zerinden iletiÅŸime geÃ§tikten sonra uzman ekibimiz adresinize gelir. KitaplarÄ±nÄ±zÄ±n deÄŸer tespitini yapar ve anÄ±nda nakit Ã¶deme yapar. Hizmet tamamen Ã¼cretsizdir ve Ä°stanbul genelinde geÃ§erlidir. Randevu almak iÃ§in +90 532 688 66 35 numaralÄ± WhatsApp hattÄ±mÄ±zÄ± arayabilirsiniz. AynÄ± gÃ¼n hizmet imkÃ¢nÄ± da bulunmaktadÄ±r.',
            imageUrl: 'https://kultur.istanbul/gorsel/2022/03/kapak.png',
            date: '2025-01-20', 
            author: 'Kitap UzmanÄ±'
        }
    ];
    
    sampleBlogs.forEach(blog => {
        addBlogToPage(blog);
    });
}

// Sayfaya blog ekle (gÃ¼ncellenmiÅŸ versiyon)
function addBlogToPage(blog) {
    const blogPosts = document.getElementById('blog-posts');
    const newPost = document.createElement('div');
    newPost.className = 'blog-post';
    newPost.setAttribute('data-id', blog.id);
    
    const previewText = blog.content.substring(0, 150) + (blog.content.length > 150 ? '...' : '');
    const showReadMore = blog.content.length > 150;
    const imageHtml = blog.imageUrl ? 
        `<img src="${blog.imageUrl}" alt="${blog.title}" onclick="openImageModal('${blog.imageUrl}', '${blog.title}')" title="FotoÄŸrafÄ± bÃ¼yÃ¼tmek iÃ§in tÄ±klayÄ±n" onerror="this.style.display='none';">` : '';
    
    newPost.innerHTML = `
        <div class="blog-post-content">
            ${imageHtml}
            <h3>${blog.title}</h3>
            <div class="blog-post-meta">${blog.date} - ${blog.author}</div>
            <p class="blog-preview">${previewText}</p>
            <div class="full-content" style="display:none;">${blog.content}</div>
            ${showReadMore ? `<a href="#" class="read-more-link" onclick="showFullPost('${blog.id}'); return false;">DevamÄ±nÄ± Oku &rarr;</a>` : ''}
        </div>
    `;
    
    blogPosts.appendChild(newPost);
}

// Admin paneline blog ekle (gÃ¼ncellenmiÅŸ versiyon)
function addBlogToAdminPanel(blog) {
    const adminList = document.getElementById('admin-blog-list');
    if (!adminList) return;
    
    const adminImageHtml = blog.imageUrl ? 
        `<img src="${blog.imageUrl}" alt="${blog.title}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 5px; float: right; cursor: pointer;" onclick="openImageModal('${blog.imageUrl}', '${blog.title}')" title="FotoÄŸrafÄ± bÃ¼yÃ¼tmek iÃ§in tÄ±klayÄ±n">` : '';
    
    const newAdminPost = document.createElement('div');
    newAdminPost.className = 'post-item';
    newAdminPost.setAttribute('data-blog-id', blog.id);
    
    newAdminPost.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div style="flex: 1;">
                <h4>${blog.title}</h4>
                <p style="color: #7f8c8d; font-size: 0.9rem;">${blog.date} - ${blog.author}</p>
                <div class="post-actions">
                    <button type="button" class="btn" style="margin-right: 0.5rem; background: #17a2b8; color: white;" onclick="copyBlogToLocalStorage('${blog.id}')">ğŸ“‹ localStorage'a Kopyala</button>
                    <button type="button" class="btn" style="background: #28a745; color: white;" onclick="downloadBlogAsJSON('${blog.id}')">ğŸ’¾ JSON Ä°ndir</button>
                </div>
            </div>
            ${adminImageHtml}
        </div>
    `;
    
    adminList.appendChild(newAdminPost);
}

// localStorage blog'u JSON formatÄ±nda kopyala
function copyBlogToLocalStorage(blogId) {
    // Bu fonksiyon manuel JSON gÃ¼ncelleme iÃ§in blog verisini hazÄ±rlar
    fetch('blogs.json?v=' + Date.now())
        .then(response => response.json())
        .then(data => {
            const blog = data.posts.find(b => b.id === blogId);
            if (blog) {
                const jsonText = JSON.stringify(blog, null, 2);
                
                // Panoya kopyala
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(jsonText).then(() => {
                        alert('âœ… Blog verisi panoya kopyalandÄ±! blogs.json dosyasÄ±na ekleyebilirsiniz.');
                    });
                } else {
                    // Fallback: Modal ile gÃ¶ster
                    showCopyModal(jsonText);
                }
            }
        })
        .catch(error => {
            alert('âŒ Blog verisi alÄ±namadÄ±: ' + error.message);
        });
}

// Blog'u JSON dosyasÄ± olarak indir
function downloadBlogAsJSON(blogId) {
    fetch('blogs.json?v=' + Date.now())
        .then(response => response.json())
        .then(data => {
            const blog = data.posts.find(b => b.id === blogId);
            if (blog) {
                const dataStr = JSON.stringify({posts: [blog]}, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `blog-${blog.id}.json`;
                link.click();
                
                alert('âœ… Blog JSON dosyasÄ± indirildi!');
            }
        })
        .catch(error => {
            alert('âŒ Blog indirilemedi: ' + error.message);
        });
}

// Kopyalama modal'Ä± gÃ¶ster
function showCopyModal(text) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    `;
    
    modal.innerHTML = `
        <div style="
            background: white;
            padding: 2rem;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        ">
            <h3 style="margin-bottom: 1rem;">Blog JSON Verisi</h3>
            <p style="margin-bottom: 1rem; color: #666;">Bu veriyi kopyalayÄ±p blogs.json dosyanÄ±za ekleyebilirsiniz:</p>
            <textarea readonly style="
                width: 100%;
                height: 300px;
                padding: 1rem;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-family: monospace;
                font-size: 0.9rem;
            ">${text}</textarea>
            <div style="text-align: right; margin-top: 1rem;">
                <button onclick="this.closest('div').parentElement.parentElement.remove()" style="
                    background: #6c757d;
                    color: white;
                    border: none;
                    padding: 0.5rem 1rem;
                    border-radius: 5px;
                    cursor: pointer;
                ">Kapat</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Ana blog yazÄ±sÄ± ekleme fonksiyonu (localStorage + JSON uyarÄ±sÄ±)
function handleBlogSubmit() {
    const title = document.getElementById('post-title').value;
    const content = document.getElementById('post-content').value;
    const imageUrl = getCurrentImageSrc();

    if (!title || !content) {
        alert('LÃ¼tfen baÅŸlÄ±k ve iÃ§erik alanlarÄ±nÄ± doldurun!');
        return;
    }

    // Blog objesi oluÅŸtur
    const blog = {
        id: 'blog-' + Date.now(),
        title: title,
        content: content,
        imageUrl: imageUrl || '',
        date: new Date().toLocaleDateString('tr-TR'),
        author: 'Admin',
        createdAt: new Date().toISOString()
    };
    
    try {
        // localStorage'a kaydet (geÃ§ici)
        const savedBlogs = localStorage.getItem('kitap-blog-posts');
        const blogs = savedBlogs ? JSON.parse(savedBlogs) : [];
        blogs.unshift(blog);
        localStorage.setItem('kitap-blog-posts', JSON.stringify(blogs));
        
        // Sayfaya ekle
        const emptyStates = document.querySelectorAll('.empty-state');
        emptyStates.forEach(state => state.remove());
        
        addBlogToPage(blog);
        addBlogToAdminPanel(blog);
        
        // Formu temizle
        document.getElementById('post-title').value = '';
        document.getElementById('post-content').value = '';
        clearImage();
        
        // JSON formatÄ±nda gÃ¶ster
        const jsonData = JSON.stringify(blog, null, 2);
        
        alert('âœ… Blog yazÄ±sÄ± eklendi!\n\nâš ï¸ NOT: Bu sadece sizin tarayÄ±cÄ±nÄ±zda gÃ¶rÃ¼nÃ¼yor.\n\nHerkesin gÃ¶rmesi iÃ§in blogs.json dosyasÄ±nÄ± gÃ¼ncelleyin.');
        
        // JSON verisini gÃ¶ster
        showCopyModal(jsonData);
        
    } catch (error) {
        alert('âŒ Blog yazÄ±sÄ± kaydedilirken hata oluÅŸtu: ' + error.message);
    }
}

// BoÅŸ durumlarÄ± gÃ¶ster (gÃ¼ncellenmiÅŸ)
function showEmptyBlogState() {
    const blogPosts = document.getElementById('blog-posts');
    blogPosts.innerHTML = `
        <div class="empty-state" style="text-align: center; padding: 4rem; color: #7f8c8d;">
            <h2 style="color: #95a5a6; margin-bottom: 1rem;">ğŸ“š Blog YazÄ±larÄ±</h2>
            <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">Blog yazÄ±larÄ± yÃ¼kleniyor...</p>
            <p style="margin: 0;">blogs.json dosyasÄ± bulunamadÄ±ysa Ã¶rnek yazÄ±lar gÃ¶sterilecek.</p>
        </div>
    `;
}

function showEmptyAdminState() {
    const adminBlogList = document.getElementById('admin-blog-list');
    if (!adminBlogList) return;
    
    adminBlogList.innerHTML = `
        <div class="empty-state" style="text-align: center; padding: 2rem; color: #7f8c8d; background: #f8f9fa; border-radius: 10px; border: 2px dashed #ddd;">
            <h4 style="color: #95a5a6; margin-bottom: 1rem;">ğŸ“ Blog YÃ¶netimi</h4>
            <p style="margin-bottom: 0.5rem;">blogs.json dosyasÄ±ndan blog yazÄ±larÄ± yÃ¼klendi.</p>
            <p style="margin: 0; font-size: 0.9rem;">Yeni blog eklemek iÃ§in yukarÄ±daki formu kullanÄ±n.</p>
        </div>
    `;
}

// Sayfa yÃ¼klendiÄŸinde JSON'dan blog'larÄ± yÃ¼kle
document.addEventListener('DOMContentLoaded', function() {
    // JSON dosyasÄ±ndan blog'larÄ± yÃ¼kle
    loadBlogsFromJSON();
    
    // Gizli admin ipucunu 10 saniye sonra gizle
    setTimeout(function() {
        const adminHint = document.querySelector('[title="Admin EriÅŸimi: Shift + Ctrl + Q"]');
        if (adminHint) {
            adminHint.style.display = 'none';
        }
    }, 10000);
});
